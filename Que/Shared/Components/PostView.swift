import SwiftUI

struct PostView: View {
    let post: Post
    let isVisible: Bool
    
    // Post s√ºre takibi i√ßin deƒüi≈ükenler
    @State private var viewStartTime: Date?
    @State private var totalViewDuration: TimeInterval = 0
    
    // Post ID'sine g√∂re rastgele renk se√ßimi
    private var backgroundColor: Color {
        let colors: [Color] = [
            .blue, .purple, .pink, .orange, .red, .green,
            .indigo, .teal, .cyan, .mint, .brown, .yellow
        ]
        let hash = abs(post.id.hashValue)
        let colorIndex = hash % colors.count
        return colors[colorIndex]
    }
    
    // PostCreationView'deki rozetin feed'e uyarlanmƒ±≈ü hali
    private var postTypeBadge: some View {
        HStack(spacing: 8) {
            Image(systemName: post.postType.icon)
                .font(.caption.weight(.semibold))
            Text(post.postType.displayName)
                .font(.caption.weight(.bold))
        }
        .foregroundColor(.white)
        .padding(.horizontal, 16)
        .padding(.vertical, 8)
        .background(
            Capsule()
                .fill(.ultraThinMaterial)
                .overlay(
                    Capsule()
                        .stroke(Color.white.opacity(0.3), lineWidth: 1)
                )
        )
        .shadow(color: .black.opacity(0.4), radius: 6, x: 0, y: 3)
    }
    
    var body: some View {
        GeometryReader { geometry in
            ZStack {
                // Arka plan
                backgroundColor
                    .ignoresSafeArea()

                // ƒ∞√ßerik
                Group {
                    if let mediaURL = post.mediaURL, let url = URL(string: mediaURL) {
                        if post.mediaType == "video" {
                            // Video post - FeedVideoPlayerViewContainer kullan
                            FeedVideoPlayerViewContainer(
                                videoURL: url,
                                postID: post.id,
                                isVisible: isVisible,
                            )
                            .frame(width: geometry.size.width, height: geometry.size.height)
                        } else if post.mediaType == "image" {
                            // Image post - CachedAsyncImage kullan
                            CachedAsyncImage(url: url) { image in
                                image
                                    .resizable()
                                    .aspectRatio(contentMode: .fill)
                                    .frame(width: geometry.size.width, height: geometry.size.height)
                                    .clipped()
                            } placeholder: {
                                Rectangle().fill(Color.gray.opacity(0.3))
                                    .frame(width: geometry.size.width, height: geometry.size.height)
                            }
                        }
                    }
                }
                
                // √úst-sol: Post t√ºr√º rozeti + metin (PostCreationView stilinde)
                VStack(alignment: .leading, spacing: 12) {
                    // G√ºvenli alan + ekstra bo≈üluk (biraz daha a≈üaƒüƒ±da ba≈ülasƒ±n)
                    Spacer().frame(height: max(geometry.safeAreaInsets.top + 40, 60))
                    
                    postTypeBadge
                    
                    Text(post.content)
                        .font(.system(size: 24, weight: .medium, design: .rounded))
                        .foregroundColor(.white)
                        .multilineTextAlignment(.leading)
                        .lineLimit(1...6)
                        .shadow(color: .black.opacity(0.8), radius: 2, x: 0, y: 1)
                }
                .frame(maxWidth: .infinity, alignment: .leading)
                .padding(.horizontal, 20)
                .padding(.trailing, 40)
                .frame(width: geometry.size.width, height: geometry.size.height, alignment: .topLeading)

                // Saƒü-alt aksiyon butonlarƒ±: Beƒüen, Beƒüenme, Yorum, Payla≈ü
                VStack {
                    Spacer()
                    VStack(spacing: 10) {
                        VStack(spacing: -6) {
                            Button(action: {
                                print("üëç Beƒüen - Post ID: \(post.id)")
                            }) {
                                actionButton(systemName: "heart")
                            }
                            Text(formatCount(post.likesCount))
                                .font(.system(size: 16, weight: .medium, design: .rounded))
                                .foregroundColor(.white)
                                .shadow(color: .black.opacity(0.8), radius: 2, x: 0, y: 1)
                        }
                        VStack(spacing: -4) {
                            Button(action: {
                                print("üëé Beƒüenme - Post ID: \(post.id)")
                            }) {
                                actionButton(systemName: "hand.thumbsdown")
                            }
                            Text(formatCount(0))
                                .font(.system(size: 16, weight: .medium, design: .rounded))
                                .foregroundColor(.white)
                                .shadow(color: .black.opacity(0.8), radius: 2, x: 0, y: 1)
                        }
                        VStack(spacing: -4) {
                            Button(action: {
                                print("üí¨ Yorum - Post ID: \(post.id)")
                            }) {
                                actionButton(systemName: "bubble.left")
                            }
                            Text(formatCount(post.commentsCount))
                                .font(.system(size: 16, weight: .medium, design: .rounded))
                                .foregroundColor(.white)
                                .shadow(color: .black.opacity(0.8), radius: 2, x: 0, y: 1)
                        }
                        Button(action: {
                            print("üîó Payla≈ü - Post ID: \(post.id)")
                        }) {
                            actionButton(systemName: "paperplane")
                        }
                    }
                    .padding(.trailing, 16)
                    .padding(.bottom, geometry.safeAreaInsets.bottom + 120)
                    .frame(maxWidth: .infinity, alignment: .trailing)
                }

                // Alt bilgi √ßubuƒüu: kullanƒ±cƒ± fotoƒürafƒ±, g√∂r√ºnen ad, kullanƒ±cƒ± adƒ± ve payla≈üƒ±lma zamanƒ±
                VStack {
                    Spacer()
                    HStack(alignment: .center, spacing: 12) {
                        if let photo = post.userPhotoURL, let url = URL(string: photo) {
                            CachedAsyncImage(url: url) { image in
                                image
                                    .resizable()
                                    .scaledToFill()
                                    .frame(width: 40, height: 40)
                                    .clipShape(Circle())
                            } placeholder: {
                                Circle()
                                    .fill(Color.white.opacity(0.25))
                                    .frame(width: 40, height: 40)
                            }
                        } else {
                            Circle()
                                .fill(Color.white.opacity(0.25))
                                .frame(width: 40, height: 40)
                        }

                        VStack(alignment: .leading, spacing: 2) {
                            Text(post.displayName)
                                .font(.system(size: 18, weight: .semibold))
                                .foregroundColor(.white)
                                .lineLimit(1)
                            HStack(spacing: 6) {
                                Text("@\(post.username)")
                                    .font(.system(size: 14, weight: .medium))
                                    .foregroundColor(.white.opacity(0.85))
                                    .lineLimit(1)
                                Text("¬∑")
                                    .foregroundColor(.white.opacity(0.6))
                                Text(post.timeAgo)
                                    .font(.system(size: 14, weight: .medium))
                                    .foregroundColor(.white.opacity(0.85))
                                    .lineLimit(1)
                            }
                        }

                        Spacer()
                    }
                    .padding(.horizontal, 16)
                    .padding(.bottom, geometry.safeAreaInsets.bottom + 120) // CustomTabBar √ºst√ºnde konumla
                    .shadow(color: .black.opacity(0.6), radius: 8, x: 0, y: 2)
                }
            }
            .frame(width: geometry.size.width, height: geometry.size.height)
            .onTapGesture(count: 2) {
                print("PostView √ßift tƒ±klandƒ± - Post ID: \(post.id)")
            }
        }
        .ignoresSafeArea(.all, edges: .all)
        .onChange(of: isVisible) { _, newValue in
            if newValue {
                // Post g√∂r√ºn√ºr hale geldi - s√ºre takibini ba≈ülat
                startViewTracking()
            } else {
                // Post g√∂r√ºnmez hale geldi - s√ºre takibini bitir
                endViewTracking()
            }
        }
        .onAppear {
            // ƒ∞lk a√ßƒ±lƒ±≈üta post g√∂r√ºn√ºrse s√ºre takibini ba≈ülat
            if isVisible {
                startViewTracking()
            }
        }
        .onDisappear {
            // PostView tamamen ekrandan √ßƒ±ktƒ±ƒüƒ±nda s√ºre takibini bitir
            endViewTracking()
        }
    }
    
    // MARK: - Reusable Action Button
    private func actionButton(systemName: String) -> some View {
        Image(systemName: systemName)
            .font(.system(size: 24, weight: .bold))
            .foregroundColor(.white)
            .frame(width: 52, height: 52)
            .shadow(color: .black.opacity(0.5), radius: 6, x: 0, y: 3)
    }
    
    // Sayƒ± kƒ±saltma: 1k, 1.1k, 1.2M gibi
    private func formatCount(_ count: Int) -> String {
        let absCount = abs(Double(count))
        let sign = (count < 0) ? "-" : ""
        switch absCount {
        case 0..<1000:
            return "\(count)"
        case 1000..<1_000_000:
            let value = absCount / 1000
            let formatted = (value >= 10) ? String(format: "%.0f", value) : String(format: "%.1f", value)
            return "\(sign)\(formatted)k"
        default:
            let value = absCount / 1_000_000
            let formatted = (value >= 10) ? String(format: "%.0f", value) : String(format: "%.1f", value)
            return "\(sign)\(formatted)M"
        }
    }
    
    // MARK: - View Tracking Methods
    
    private func startViewTracking() {
        guard viewStartTime == nil else { return } // Zaten ba≈ülatƒ±lmƒ±≈üsa tekrar ba≈ülatma
        
        viewStartTime = Date()
        print("üìä Post g√∂r√ºnt√ºleme ba≈üladƒ± - Post ID: \(post.id) - Ba≈ülangƒ±√ß: \(Date())")
    }
    
    private func endViewTracking() {
        guard let startTime = viewStartTime else { return } // Ba≈ülangƒ±√ß zamanƒ± yoksa i≈ülem yapma
        
        let endTime = Date()
        let duration = endTime.timeIntervalSince(startTime)
        totalViewDuration += duration
        
        print("üìä Post g√∂r√ºnt√ºleme bitti - Post ID: \(post.id)")
        print("üìä Bu oturum s√ºresi: \(String(format: "%.2f", duration)) saniye")
        print("üìä Toplam g√∂r√ºnt√ºleme s√ºresi: \(String(format: "%.2f", totalViewDuration)) saniye")
        print("üìä Post Tipi: \(post.mediaType ?? "metin")")
        print("üìä ---")
        
        // Ba≈ülangƒ±√ß zamanƒ±nƒ± sƒ±fƒ±rla
        viewStartTime = nil
    }
}
